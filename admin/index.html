<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>

    <script>
      // Phase 1: Pre-load fix (query → hash)
      (function () {
        const searchParams = new URLSearchParams(window.location.search);
        const hash = window.location.hash;

        if (searchParams.has("access_token")) {
          const token = searchParams.get("access_token");
          const type = searchParams.get("token_type");
          window.location.replace(`/admin#access_token=${token}&token_type=${type}`);
        } else if (hash.startsWith("#/access_token=")) {
          const fixedHash = "#" + hash.substring(2); // remove "/"
          window.location.replace(`/admin${fixedHash}`);
        }
      })();
    </script>
  </head>
  <body>
    <!-- Load Decap CMS -->
    <script src="https://unpkg.com/decap-cms@3.0.12/dist/decap-cms.js"></script>

    <script>
      // Phase 2: Post-load fix (in case Decap re-adds #/)
      window.addEventListener("hashchange", function () {
        if (window.location.hash.startsWith("#/access_token=")) {
          const fixedHash = "#" + window.location.hash.substring(2);
          console.log("Decap Patch (post-load): fixing hash to", fixedHash);
          window.location.replace(`/admin${fixedHash}`);
        }
      });

      // Debug: token detection
      if (window.location.hash.includes("access_token")) {
        console.log("Decap Debug: Final token detected →", window.location.hash);
      } else {
        console.log("Decap Debug: No final token in hash.");
      }
    </script>
  </body>
</html>
